<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Kexin Tang">
    
    <title>
        
            DDIA cookbook - (7)Transactions |
        
        Kexin&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/otter-solid.svg">
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"kexintang.xyz","root":"/","language":"en","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#ff9f43","logo":null,"favicon":"/images/otter-solid.svg","avatar":"/images/OtterAvatar.jpg","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"闲云野鹤||A lone cloud","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":false,"auto":false,"custom_label_list":[]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":false},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original article title","author":"Original article author","link":"Original article link"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
               Kexin&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               target="_blank" rel="noopener" href="https://drive.google.com/file/d/13-0bw5teEW1AYoNnH5pRfsbnT48hkBJr/view?usp=drive_link"
                            >
                                RESUME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       target="_blank" rel="noopener" href="https://drive.google.com/file/d/13-0bw5teEW1AYoNnH5pRfsbnT48hkBJr/view?usp=drive_link">RESUME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">DDIA cookbook - (7)Transactions</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/OtterAvatar.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">Kexin Tang</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-09-17 23:14:38</span>
        <span class="mobile">2023-09-17 23:14</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-10-29 22:16:02</span>
    </span>
    
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/System-Design/">System Design</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/DDIA/">DDIA</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <h1 id="Concept-of-Transaction"><a href="#Concept-of-Transaction" class="headerlink" title="Concept of Transaction"></a>Concept of Transaction</h1><p>A transaction is a way for an application to group several reads and writes together into a logical unit. Conceptually, <strong>all the reads and writes in a transaction are executed as one operation: either the entire transaction succeeds (commit) or it fails (abort, rollback)</strong>.</p>
<p>Not every application needs transactions, and sometimes there are advantages to weakening transactional guarantees or abandoning them entirely (for example, to achieve higher performance or higher availability).</p>
<h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><h3 id="Atomicity"><a href="#Atomicity" class="headerlink" title="Atomicity"></a>Atomicity</h3><p>For a group of operations, if no fault occurs, then execute all operations and change the state (commit); otherwise, no operation will be executed, keep original state (abort).</p>
<blockquote>
<p>Different with <em>atomic</em> in multi-threaded.</p>
<p>In multi-threaded programming, if one thread executes an atomic operation, that means there is no way that another thread could see the half-finished result of the operation. The system can only be in the state it was before the operation or after the operation, not something in between.</p>
<p>For ACID, it does not describe what happens if several processes try to access the same data at the same time.</p>
</blockquote>
<h3 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h3><p>The idea of ACID consistency is that you have certain statements about your data (invariants) that must always be true, if a transaction starts with a database that is valid according to these invariants, and any writes during the transaction preserve the validity, then you can be sure that the invariants are always satisfied.</p>
<blockquote>
<p>This idea of consistency <strong>depends on the application’s notion</strong> of invariants, and it’s the application’s responsibility to define its transactions correctly so that they preserve consistency. <strong>This is not something that the database can guarantee</strong>.</p>
</blockquote>
<blockquote>
<p>This consistency is not the same as consistency in distributed systems (called CAP). ACID consistency is a user-defined rule, while CAP consistency is “request to any nodes will get the same response”.</p>
</blockquote>
<h3 id="Isolation"><a href="#Isolation" class="headerlink" title="Isolation"></a>Isolation</h3><p>Any read or write in the same transaction will not be affected by other transactions.</p>
<p>For details, please refer to <em>“Concurrent Operations &amp; Isolation Levels”</em> section.</p>
<h4 id="Possible-Problems"><a href="#Possible-Problems" class="headerlink" title="Possible Problems"></a>Possible Problems</h4><p><img  
                     lazyload
                     alt="image"
                     data-src="https://i.imgur.com/OoiV91f.jpg"
                      alt="problem"
                ></p>
<ul>
<li><strong>Dirty Read</strong> &rarr; A Dirty read is a situation when a transaction reads data that has not yet been committed.</li>
<li><strong>Non Repeatable read</strong> &rarr; Non Repeatable read occurs when a transaction reads the same row twice and gets a different value each time.</li>
<li><strong>Phantom Read</strong> &rarr; Phantom Read occurs when two same queries are executed, but the rows retrieved by the two, are different.</li>
</ul>
<blockquote>
<p>Difference between <em>non repeatable</em> and <em>phantom</em> is: non repeatable focus on certain row, and the returned value of that row; phantom focus on same query and the returned set.</p>
</blockquote>
<h4 id="Isolation-levels"><a href="#Isolation-levels" class="headerlink" title="Isolation levels"></a>Isolation levels</h4><p>Levels from loose to strict:</p>
<ul>
<li><strong>Read Uncommitted</strong> (no isolation) &rarr; In this level, one transaction may read not yet committed changes made by other transactions, thereby allowing dirty reads.</li>
<li><strong>Read Committed</strong> &rarr; This isolation level guarantees that any data read is committed at the moment it is read. Thus it does not allow dirty read. The transaction holds a read or write lock on the current row, and thus prevents other transactions from reading, updating, or deleting it.</li>
<li><strong>Repeatable Read</strong> &rarr; The transaction holds read locks on all rows it references and writes locks on referenced rows for update and delete actions. Since other transactions cannot read, update or delete these rows, consequently it avoids non-repeatable read.</li>
<li><strong>Serializable</strong> (purely like ordered transactions) &rarr; A serializable execution is guaranteed to be serializable. Serializable execution is defined to be an execution of operations in which concurrently executing transactions appears to be serially executing.</li>
</ul>
<h3 id="Durability"><a href="#Durability" class="headerlink" title="Durability"></a>Durability</h3><p>Durability is the promise that once a transaction has committed successfully, any data it has written will not be forgotten, even if there is a hardware fault or the database crashes.</p>
<ul>
<li>single-node &rarr; write data into disk or WAL for recovery.</li>
<li>multi-nodes &rarr; data has been successfully copied to some number of nodes.</li>
</ul>
<h2 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h2><p>Systems that do not meet the ACID criteria are sometimes called <strong>BASE</strong>, which stands for <em><strong>Basically Available</strong></em>, <em><strong>Soft state</strong></em>, and <em><strong>Eventual consistency</strong></em>.</p>
<h2 id="Single-Object-Multi-Object-Operations"><a href="#Single-Object-Multi-Object-Operations" class="headerlink" title="Single-Object &amp; Multi-Object Operations"></a>Single-Object &amp; Multi-Object Operations</h2><h3 id="single-object-writes"><a href="#single-object-writes" class="headerlink" title="single-object writes"></a>single-object writes</h3><p>Single object modification means multiple threads may access the same value (row, table, etc). Atomicity can be implemented using a <strong>log</strong> for crash recovery and isolation can be implemented using a <strong>lock</strong> on each object.</p>
<blockquote>
<p>Atomicity for single object may be hard to understand because only one operation happens, you can imagine it like “write a very large data chunk into disk”, there are two outcomes: (1) all data in disk; (2) no data in disk.</p>
</blockquote>
<p>Some databases also provide more complex atomic operations, such as an increment operation, which removes the need for a read-modify-write cycle. Similarly popular is a compare-and-set operation, which allows a write to happen only if the value has not been concurrently changed by someone else. We will cover this later.</p>
<p>These single-object operations are useful, as they can prevent lost updates when several clients try to write to the same object concurrently. However, they are not transactions in the usual sense of the word, because transaction means we operate more than one objects.</p>
<h3 id="multi-object-transactions"><a href="#multi-object-transactions" class="headerlink" title="multi-object transactions"></a>multi-object transactions</h3><p>Some distributed databases abandon multi-object transactions because it’s difficult to implement across partitions and may influent performance and availability.</p>
<p>But there are some situations that still require multi-object transactions, for example:</p>
<ul>
<li>foreign key constrain</li>
<li>secondary index</li>
</ul>
<h3 id="Handling-errors-and-aborts"><a href="#Handling-errors-and-aborts" class="headerlink" title="Handling errors and aborts"></a>Handling errors and aborts</h3><p>ACID databases are based on this philosophy: if the database is in danger of violating its guarantee of atomicity, isolation, or durability, it would rather abandon the transaction entirely than allow it to remain half-finished.</p>
<p>Not all systems follow that philosophy, though. In particular, datastores with leaderless replication work much more on a “best effort” basis, which could be summarized as “the database will do as much as it can, and if it runs into an error, it won’t undo something it has already done”—so it’s the application’s responsibility to recover from errors.</p>
<p><strong>Retrying an aborted transaction</strong> is a simple and effective error handling mechanism, it isn’t perfect:</p>
<ul>
<li>If the transaction success but the network fails to response to client, then retry may execute same transaction twice.</li>
<li>If the error is due to overload, then retry will make the problem worse.</li>
<li>It’s only worth retrying after transient errors, like deadlock, temporary network break, etc. For permanent error such as constraint violation, retrying is meaningless.</li>
<li>If the transaction has side effect, then even transaction failed, the side effect may affect other part already.</li>
<li>If the client fails while retrying, then everything is lost.</li>
</ul>
<hr>
<h1 id="Weak-Isolation-Levels"><a href="#Weak-Isolation-Levels" class="headerlink" title="Weak Isolation Levels"></a>Weak Isolation Levels</h1><h2 id="Read-Committed"><a href="#Read-Committed" class="headerlink" title="Read Committed"></a>Read Committed</h2><h3 id="Dirty-Read"><a href="#Dirty-Read" class="headerlink" title="Dirty Read"></a>Dirty Read</h3><p><strong>No dirty read</strong> &rarr; When reading from the database, you will only see data that has been committed.</p>
<p>Why need to avoid dirty read?</p>
<ol>
<li>If a transaction needs to update several objects, a dirty read means that another transaction may see some of the updates but not others.<blockquote>
<p>For example, the user sees the new unread email but not the updated counter. This is a dirty read of the email. Seeing the database in a partially updated state is confusing to users and may cause other transactions to take incorrect decisions.</p>
</blockquote>
</li>
<li>If a transaction aborts, any writes it has made need to be rolled back. If the database allows dirty reads, that means a transaction may see data that is later rolled back.</li>
</ol>
<h3 id="Dirty-Write"><a href="#Dirty-Write" class="headerlink" title="Dirty Write"></a>Dirty Write</h3><p><strong>No dirty write</strong> &rarr; When writing to the database, you will only overwrite data that has been committed.</p>
<p>We normally assume that the later write overwrites the earlier write. However, what happens if the earlier write is part of a transaction that has not yet committed, so the later write overwrites an uncommitted value? This is called a dirty write.</p>
<h3 id="Implement-Read-Committed"><a href="#Implement-Read-Committed" class="headerlink" title="Implement Read Committed"></a>Implement Read Committed</h3><p>Most commonly, databases prevent <strong>dirty writes</strong> by using <strong>row-level locks</strong>: when a transaction wants to modify a particular object (row or document), it must first acquire a lock on that object. It must then hold that lock until the transaction is committed or aborted. Only one transaction can hold the lock for any given object; if another transaction wants to write to the same object, it must wait until the first transaction is committed or aborted before it can acquire the lock and continue.</p>
<p>What about preventing <strong>dirty reads</strong>?</p>
<ul>
<li>One option is use the same <strong>read lock</strong>, but it’s not a good idea, because one long-running write transaction can force many read-only transactions to wait until the long-running transaction has completed. This harms the response time of read-only transactions and is bad for operability.</li>
<li>Another option is <strong>keeping both committed and uncommitted values</strong>.  For every object that is written, the database remembers both the old committed value and the new value set by the transaction that currently holds the write lock. While the transaction is ongoing, any other transactions that read the object are simply given the old value. Only when the new value is committed do transactions switch over to reading the new value.</li>
</ul>
<h2 id="Snapshot-Isolation-and-Repeatable-Read"><a href="#Snapshot-Isolation-and-Repeatable-Read" class="headerlink" title="Snapshot Isolation and Repeatable Read"></a>Snapshot Isolation and Repeatable Read</h2><p><img  
                     lazyload
                     alt="image"
                     data-src="https://i.imgur.com/diMcESY.png"
                      alt="non repeatable read"
                ></p>
<p>This is called <strong>non repeatable read</strong>.</p>
<p>Snapshot isolation is the most common solution to this problem. The idea is that <strong>each transaction reads from a consistent snapshot of the database—that is, the transaction sees all the data that was committed in the database at the start of the transaction</strong>. Even if the data is subsequently changed by another transaction, each transaction sees only the old data from that particular point in time.</p>
<h3 id="Implement-Snapshot-Isolation-MVCC"><a href="#Implement-Snapshot-Isolation-MVCC" class="headerlink" title="Implement Snapshot Isolation (MVCC)"></a>Implement Snapshot Isolation (MVCC)</h3><p>Like read committed isolation, implementations of snapshot isolation typically use <strong>write locks</strong> to prevent <strong>dirty writes</strong>.</p>
<p>However, <strong>reads do not require any locks</strong>. From a performance point of view, a key principle of snapshot isolation is readers never block writers, and writers never block readers. This allows a database to handle long-running read queries on a consistent snapshot at the same time as processing writes normally, without any lock contention between the two.</p>
<p>The database must potentially keep several different committed versions of an object, because various in-progress transactions may need to see the state of the database at different points in time. Because it maintains several versions of an object side by side, this technique is known as <strong>multiversion concurrency control (MVCC)</strong>.</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://i.imgur.com/e8wEUnW.png"
                      alt="mvcc in postgresql"
                ></p>
<p>Each row in a table has a <em>created_by</em> field, containing the ID of the transaction that inserted this row into the table.</p>
<p>Moreover, each row has a <em>deleted_by</em> field, which is initially empty. If a transaction deletes a row, the row isn’t actually deleted from the database, but it is marked for deletion by setting the <em>deleted_by</em> field to the ID of the transaction that requested the deletion. At some later time, when it is certain that no transaction can any longer access the deleted data, a garbage collection process in the database removes any rows marked for deletion and frees their space.</p>
<p>An update is internally translated into a delete and a create.</p>
<h3 id="Visibility-rules"><a href="#Visibility-rules" class="headerlink" title="Visibility rules"></a>Visibility rules</h3><p>When a transaction reads from the database, transaction IDs are used to decide which objects it can see and which are invisible.</p>
<ol>
<li>At the start of each transaction, the database makes a list of all the other transactions that are in progress (not yet committed or aborted) at that time. Any writes that those transactions have made are ignored, even if the transactions subsequently commit.</li>
<li>Any writes made by aborted transactions are ignored.</li>
<li>Any writes made by transactions with a later transaction ID (i.e., which started after the current transaction started) are ignored, regardless of whether those transactions have committed.</li>
<li>All other writes are visible to the application’s queries.</li>
</ol>
<p>In other words, an object is visible if both of the following conditions are true:</p>
<ol>
<li>At the time when the reader’s transaction started, the transaction that created the object had already committed.</li>
<li>The object is not marked for deletion, or if it is, the transaction that requested deletion had not yet committed at the time when the reader’s transaction started.</li>
</ol>
<h3 id="Indexes"><a href="#Indexes" class="headerlink" title="Indexes"></a>Indexes</h3><ol>
<li><strong>The index simply point to all versions of an object and require an index query to filter out any object versions that are not visible to the current transaction</strong>. When garbage collection removes old object versions that are no longer visible to any transaction, the corresponding index entries can also be removed.</li>
<li><strong>Use an append-only&#x2F;copy-on-write variant that does not overwrite pages of the tree when they are updated, but instead creates a new copy of each modified page</strong>. Parent pages, up to the root of the tree, are copied and updated to point to the new versions of their child pages.</li>
</ol>
<h2 id="Preventing-Lost-Updates"><a href="#Preventing-Lost-Updates" class="headerlink" title="Preventing Lost Updates"></a>Preventing Lost Updates</h2><p>There are several interesting kinds of conflicts that can occur between concurrently writing transactions. The best known of these is the <strong>lost update</strong> problem.</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://i.imgur.com/lk5OVSW.png"
                      alt="Lost Updates"
                ></p>
<p>The lost update problem can occur if <strong>an application reads some value from the database, modifies it, and writes back the modified value (a read-modify-write cycle)</strong>. If two transactions do this concurrently, one of the modifications can be lost, because the second write does not include the first modification.</p>
<h3 id="Atomic-write-operaitons"><a href="#Atomic-write-operaitons" class="headerlink" title="Atomic write operaitons"></a>Atomic write operaitons</h3><p>Many databases provide atomic update operations, which remove the need to implement read-modify-write cycles in application code.</p>
<blockquote>
<p>This means a new operation always happens after the old operation finishing.</p>
</blockquote>
<p>Atomic operations are usually implemented by taking an <strong>exclusive lock on the object</strong> when it is read so that no other transaction can read it until the update has been applied. Another option is to simply force all atomic operations to be executed on a <strong>single thread</strong>.</p>
<p>Unfortunately, object-relational mapping frameworks make it easy to accidentally write code that performs unsafe read-modify-write cycles instead of using atomic operations provided by the database.</p>
<blockquote>
<p>Although DB provide threading-safe SQL commands, user may use the DB in a wrong way and violate the atomicity :(.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># threading-safe</span></span><br><span class="line">MyDB.execute(<span class="string">&quot;UPDATE counters SET value = value + 1 WHERE key = &#x27;foo&#x27;;&quot;</span>)</span><br><span class="line"><span class="comment"># violate atomicity</span></span><br><span class="line">value = MyDB.execute(<span class="string">&quot;SELECT value FROM counters WHERE key = &#x27;foo&#x27;;&quot;</span>)</span><br><span class="line">new_value = value + <span class="number">1</span></span><br><span class="line">MyDB.execute(<span class="string">&quot;UPDATE counters SET value = new_value WHERE key = &#x27;foo&#x27;;&quot;</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="Explicit-locking"><a href="#Explicit-locking" class="headerlink" title="Explicit locking"></a>Explicit locking</h3><p>Add lock in your own code.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> resource.get_lock() <span class="keyword">as</span> re:</span><br><span class="line">    do_something()</span><br></pre></td></tr></table></figure>

<h3 id="Automatically-detecting-lost-updates"><a href="#Automatically-detecting-lost-updates" class="headerlink" title="Automatically detecting lost updates"></a>Automatically detecting lost updates</h3><p>Allow to run operations in parallel, if the transaction manager detects a lost update, abort the transaction and force it to retry its read-modify-write cycle.</p>
<h3 id="Compare-and-Set"><a href="#Compare-and-Set" class="headerlink" title="Compare and Set"></a>Compare and Set</h3><p><strong>Compare-and-set operation</strong> is to avoid lost updates by allowing an update to happen only if the value has not changed since you last read it. If the current value does not match what you previously read, abort the update, and the read-modify-write cycle must be retried.</p>
<h3 id="Conflict-resolution-and-replication"><a href="#Conflict-resolution-and-replication" class="headerlink" title="Conflict resolution and replication"></a>Conflict resolution and replication</h3><p>Locks and compare-and-set operations assume that there is a single up-to-date copy of the data. However, databases with multi-leader or leaderless replication usually allow several writes to happen concurrently and replicate them asynchronously, so they cannot guarantee that there is a single up-to-date copy of the data. Thus, <strong>techniques based on locks or compare-and-set do not apply in this context</strong>.</p>
<p>Solution &rarr; allow concurrent writes to create several conflicting versions of a value (also known as siblings), and to use application code or special data structures to resolve and merge these versions after the fact.</p>
<h2 id="Write-Skew-and-Phantoms"><a href="#Write-Skew-and-Phantoms" class="headerlink" title="Write Skew and Phantoms"></a>Write Skew and Phantoms</h2><h3 id="Write-Skew"><a href="#Write-Skew" class="headerlink" title="Write Skew"></a>Write Skew</h3><p>It is neither a dirty write nor a lost update, because <strong>the two transactions are updating two different objects</strong>.</p>
<p>You can think of <strong>write skew as a generalization of the lost update problem</strong>. Write skew can occur if two transactions read the same objects, and then update some of those objects (different transactions may update different objects). In the special case where different transactions update the same object, you get a dirty write or lost update anomaly.</p>
<h3 id="Phantoms"><a href="#Phantoms" class="headerlink" title="Phantoms"></a>Phantoms</h3><p>A write in one transaction changes the result of a search query in another transaction, is called a <strong>phantom</strong>. Snapshot isolation avoids phantoms in read-only queries, but in read-write transactions, phantoms can lead to particularly tricky cases of write skew.</p>
<p>The general steps that cause phantoms are:</p>
<ol>
<li>A SELECT query checks whether some requirement is satisfied by searching for rows that match some search condition.</li>
<li>Depending on the result of the first query, the application code decides how to continue</li>
<li>If the application decides to go ahead, it makes a write (INSERT, UPDATE, or DELETE) to the database and commits the transaction</li>
</ol>
<h3 id="Materializing-conflicts"><a href="#Materializing-conflicts" class="headerlink" title="Materializing conflicts"></a>Materializing conflicts</h3><p>Materializing conflicts &rarr; takes a phantom and turns it into a lock conflict on a concrete set of rows that exist in the database.</p>
<p>It can be hard and error-prone to figure out how to materialize conflicts, and it’s ugly to let a concurrency control mechanism leak into the application data model.</p>
<hr>
<h1 id="Serializability"><a href="#Serializability" class="headerlink" title="Serializability"></a>Serializability</h1><p>Serializable isolation is usually regarded as the strongest isolation level. It guarantees that even though transactions may execute in parallel, the end result is the same as if they had executed one at a time, serially, without any concurrency.</p>
<p>Most databases that provide serializability today use one of three techniques:</p>
<ol>
<li>actual serial execution</li>
<li>two-phase locking</li>
<li>concurrency control</li>
</ol>
<h2 id="Actual-Serial-Execution"><a href="#Actual-Serial-Execution" class="headerlink" title="Actual Serial Execution"></a>Actual Serial Execution</h2><p>The simplest way of avoiding concurrency problems is to <strong>remove the concurrency</strong> entirely: to <strong>execute only one transaction at a time, in serial order, on a single thread</strong>.</p>
<blockquote>
<p>It seems very straight forward, why this appears only recently?</p>
<ol>
<li>RAM became cheap enough that for many use cases is now feasible to keep the entire active dataset in memory.</li>
<li>OLTP transactions are usually short and only make a small number of reads and writes. For long-running analytics quries, they are typically read-heavy and can use snapshot.</li>
</ol>
</blockquote>
<p><strong>A system designed for single-threaded execution can sometimes perform better than a system that supports concurrency, because it can avoid the coordination overhead of locking</strong>.</p>
<p>However, <strong>its throughput is limited to that of a single CPU core</strong>. In order to make the most of that single thread, transactions need to be structured differently from their traditional form.</p>
<h3 id="Encapsulating-transactions-in-stored-procedures"><a href="#Encapsulating-transactions-in-stored-procedures" class="headerlink" title="Encapsulating transactions in stored procedures"></a>Encapsulating transactions in stored procedures</h3><p>If a database transaction needs to wait for input from a user, the database needs to support a potentially huge number of concurrent transactions, most of them idle. Most databases cannot do that efficiently, and so almost all OLTP applications keep transactions short by avoiding interactively waiting for a user within a transaction.</p>
<p>In this interactive style of transaction, a lot of time is spent in network communication between the application and the database. If you were to disallow concurrency in the database and only process one transaction at a time, the throughput would be dreadful because the database would spend most of its time waiting for the application to issue the next query for the current transaction.</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://i.imgur.com/DJBON40.png"
                      alt="stored procedures"
                ></p>
<p>Systems with single-threaded serial transaction processing don’t allow interactive multi-statement transactions. Instead, <strong>the application must submit the entire transaction code to the database ahead of time, as a stored procedure</strong>.</p>
<blockquote>
<p>Normal process is running multiple queries one by one, which looks like execute multiple commands in console;<br>Stored procedure is packing multiple queries together and send this batch via network, which looks like running script.</p>
</blockquote>
<h3 id="Pros-and-cons-of-stored-procedures"><a href="#Pros-and-cons-of-stored-procedures" class="headerlink" title="Pros and cons of stored procedures"></a>Pros and cons of stored procedures</h3><p>Some cons:</p>
<ol>
<li>Each database vendor has its own language for stored procedures</li>
<li>Hard to debug, monitor, test, version control, etc</li>
<li>A badly written stored procedures in the database may cause much more trouble than bad code in applications, because one database may be used by several applications</li>
</ol>
<p>Some pros:</p>
<ol>
<li>With stored procedures and <strong>in-memory data</strong>, executing all transactions on a single thread becomes feasible. As they don’t need to wait for I&#x2F;O and they avoid the overhead of other concurrency control mechanisms, they can achieve quite good throughput on a single thread.</li>
<li>Some database use stored procedures for replication: instead of copying a transaction’s writes from one node to another, they execute the same stored procedure on each replica. (no need to transfer data, just transfer the script or “how to get these data”)</li>
</ol>
<h3 id="Partitioning"><a href="#Partitioning" class="headerlink" title="Partitioning"></a>Partitioning</h3><p><strong>Executing all transactions serially makes concurrency control much simpler, but limits the transaction throughput of the database to the speed of a single CPU core on a single machine</strong>. Read-only transactions may execute elsewhere, using snapshot isolation, but for applications with high write throughput, the single-threaded transaction processor can become a serious bottleneck.</p>
<p>In order to scale to multiple CPU cores, and multiple nodes, you can potentially <strong>partition</strong> your data.</p>
<ul>
<li>If you can find a way of partitioning your dataset so that each transaction only needs to read and write data within a single partition, then each partition can have its own transaction processing thread running independently from the others. In this case, you can give each CPU core its own partition, which allows your transaction throughput to scale linearly with the number of CPU cores.</li>
<li>However, for any transaction that needs to access multiple partitions, the database must coordinate the transaction across all the partitions that it touches. The stored procedure needs to be performed in lock-step across all partitions to ensure serializability across the whole system.</li>
</ul>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Serial execution of transactions has become a viable way of achieving serializable isolation within certain constraints:</p>
<ol>
<li>Every transaction must be small and fast, because we only have one tread, low-speed transaction will block following tasks.</li>
<li>It is limited to use cases where the active dataset can fit in memory so that no need to wait to load data from disk.</li>
<li>Write throughput must be low enough to be handled on a single CPU core.</li>
<li>Rare cross-partition transations.</li>
</ol>
<h2 id="Two-Phase-Locking-2PL"><a href="#Two-Phase-Locking-2PL" class="headerlink" title="Two-Phase Locking (2PL)"></a>Two-Phase Locking (2PL)</h2><p><strong>NOTE: TWO-PHASE LOCKING IS DIFFERENT WITH TWO-PHASE COMMIT!!!</strong></p>
<p>Several transactions are allowed to concurrently read the same object as long as nobody is writing to it. But as soon as anyone wants to write (modify or delete) an object, exclusive access is required:</p>
<ul>
<li>If transaction A has read an object and transaction B wants to write to that object, B must wait until A commits or aborts before it can continue.</li>
<li>If transaction A has written an object and transaction B wants to read that object, B must wait until A commits or aborts before it can continue.</li>
</ul>
<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><p>There are 2 lock types: <strong>shared lock</strong> (read lock) and <strong>exclusive lock</strong> (write lock).</p>
<ul>
<li>Readers &rarr; acquire and hold shared lock, multiple readers can share the lock on the same object. If the object already has an exclusive lock, then readers need to wait.</li>
<li>Writer &rarr; acquires and holds exclusive lock. One object can only has one exclusive lock, so if there is any existing lock on the object, the transaction must wait.</li>
<li>Lock Upgrade &rarr; If a transaction first reads and then writes an object, it may upgrade its shared lock to an exclusive lock.</li>
<li>After a transaction has acquired the lock, it must continue to hold the lock until the end of the transaction (commit or abort).</li>
</ul>
<blockquote>
<p>One of the problem of 2PL is <strong>deadlock</strong>. The most common solution is detecting the deadlocks between transactions then aborting one of them to break the tie.</p>
</blockquote>
<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><h3 id="Predicate-locks"><a href="#Predicate-locks" class="headerlink" title="Predicate locks"></a>Predicate locks</h3><h3 id="Index-range-locks"><a href="#Index-range-locks" class="headerlink" title="Index-range locks"></a>Index-range locks</h3><h2 id="Optimistic-Concurrency-Control-OCC"><a href="#Optimistic-Concurrency-Control-OCC" class="headerlink" title="Optimistic Concurrency Control (OCC)"></a>Optimistic Concurrency Control (OCC)</h2>
            </div>

            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/System-Design/">#System Design</a>&nbsp;
                        </li>
                    
                        <li class="tag-item">
                            <a href="/tags/DDIA/">#DDIA</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/09/12/What-is-pyi-file/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">What is .pyi file</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Concept-of-Transaction"><span class="nav-number">1.</span> <span class="nav-text">Concept of Transaction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ACID"><span class="nav-number">1.1.</span> <span class="nav-text">ACID</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Atomicity"><span class="nav-number">1.1.1.</span> <span class="nav-text">Atomicity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consistency"><span class="nav-number">1.1.2.</span> <span class="nav-text">Consistency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Isolation"><span class="nav-number">1.1.3.</span> <span class="nav-text">Isolation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Possible-Problems"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">Possible Problems</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Isolation-levels"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">Isolation levels</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Durability"><span class="nav-number">1.1.4.</span> <span class="nav-text">Durability</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BASE"><span class="nav-number">1.2.</span> <span class="nav-text">BASE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Single-Object-Multi-Object-Operations"><span class="nav-number">1.3.</span> <span class="nav-text">Single-Object &amp; Multi-Object Operations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#single-object-writes"><span class="nav-number">1.3.1.</span> <span class="nav-text">single-object writes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#multi-object-transactions"><span class="nav-number">1.3.2.</span> <span class="nav-text">multi-object transactions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Handling-errors-and-aborts"><span class="nav-number">1.3.3.</span> <span class="nav-text">Handling errors and aborts</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Weak-Isolation-Levels"><span class="nav-number">2.</span> <span class="nav-text">Weak Isolation Levels</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Read-Committed"><span class="nav-number">2.1.</span> <span class="nav-text">Read Committed</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dirty-Read"><span class="nav-number">2.1.1.</span> <span class="nav-text">Dirty Read</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dirty-Write"><span class="nav-number">2.1.2.</span> <span class="nav-text">Dirty Write</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Implement-Read-Committed"><span class="nav-number">2.1.3.</span> <span class="nav-text">Implement Read Committed</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Snapshot-Isolation-and-Repeatable-Read"><span class="nav-number">2.2.</span> <span class="nav-text">Snapshot Isolation and Repeatable Read</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Implement-Snapshot-Isolation-MVCC"><span class="nav-number">2.2.1.</span> <span class="nav-text">Implement Snapshot Isolation (MVCC)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Visibility-rules"><span class="nav-number">2.2.2.</span> <span class="nav-text">Visibility rules</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Indexes"><span class="nav-number">2.2.3.</span> <span class="nav-text">Indexes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Preventing-Lost-Updates"><span class="nav-number">2.3.</span> <span class="nav-text">Preventing Lost Updates</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Atomic-write-operaitons"><span class="nav-number">2.3.1.</span> <span class="nav-text">Atomic write operaitons</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Explicit-locking"><span class="nav-number">2.3.2.</span> <span class="nav-text">Explicit locking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Automatically-detecting-lost-updates"><span class="nav-number">2.3.3.</span> <span class="nav-text">Automatically detecting lost updates</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Compare-and-Set"><span class="nav-number">2.3.4.</span> <span class="nav-text">Compare and Set</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conflict-resolution-and-replication"><span class="nav-number">2.3.5.</span> <span class="nav-text">Conflict resolution and replication</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Skew-and-Phantoms"><span class="nav-number">2.4.</span> <span class="nav-text">Write Skew and Phantoms</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-Skew"><span class="nav-number">2.4.1.</span> <span class="nav-text">Write Skew</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Phantoms"><span class="nav-number">2.4.2.</span> <span class="nav-text">Phantoms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Materializing-conflicts"><span class="nav-number">2.4.3.</span> <span class="nav-text">Materializing conflicts</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Serializability"><span class="nav-number">3.</span> <span class="nav-text">Serializability</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Actual-Serial-Execution"><span class="nav-number">3.1.</span> <span class="nav-text">Actual Serial Execution</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Encapsulating-transactions-in-stored-procedures"><span class="nav-number">3.1.1.</span> <span class="nav-text">Encapsulating transactions in stored procedures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pros-and-cons-of-stored-procedures"><span class="nav-number">3.1.2.</span> <span class="nav-text">Pros and cons of stored procedures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Partitioning"><span class="nav-number">3.1.3.</span> <span class="nav-text">Partitioning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">3.1.4.</span> <span class="nav-text">Summary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Two-Phase-Locking-2PL"><span class="nav-number">3.2.</span> <span class="nav-text">Two-Phase Locking (2PL)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Implementation"><span class="nav-number">3.2.1.</span> <span class="nav-text">Implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performance"><span class="nav-number">3.2.2.</span> <span class="nav-text">Performance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Predicate-locks"><span class="nav-number">3.2.3.</span> <span class="nav-text">Predicate locks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-range-locks"><span class="nav-number">3.2.4.</span> <span class="nav-text">Index-range locks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Optimistic-Concurrency-Control-OCC"><span class="nav-number">3.3.</span> <span class="nav-text">Optimistic Concurrency Control (OCC)</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2023</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">Kexin Tang</a>
            
        </div>
        
            <script async data-pjax
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>





    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-block.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/post-helper.js"></script>

        
            
<script src="/js/libs/anime.min.js"></script>

        
        
            
<script src="/js/toc.js"></script>

        
    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
